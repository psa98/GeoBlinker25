<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .leaflet-control-attribution a {
            pointer-events: none !important;
            cursor: default !important;
            text-decoration: none !important;
            color: #666 !important;
        }
    </style>
    <link rel="stylesheet" href="file:///android_asset/map.css"/>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var customIcons = {};
    var map;
    var currentLayer;
    var markers = {};
    var layers = {
        light: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }),
        dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap',
            className: 'dark-theme' // Добавляем класс для тёмной темы
        }),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© Esri'
        })
    };
    var currentZoom = 10;
    var markerPrevPos = {};
    var markerColor   = {};
    var trackLines = [];

    function randomColor() {
        return '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
    }

    function initMap() {
        map = L.map('map', {
            doubleClickZoom: false,
            zoomControl: false,
            minZoom: 3,
            maxZoom: 18,
            layers: [layers.light]
        }).setView([55.752, 37.623], 10);

        currentLayer = layers.light;

        map.on('zoomend', function() {
            currentZoom = map.getZoom();
        });

        map.getContainer().addEventListener('click', function(e) {
            if (e.target.closest('.leaflet-control-attribution')) {
                e.preventDefault();
                e.stopPropagation();
            }
        });
    }

    function updateMap(lat, lng, zoom) {
        map.setView([lat, lng], zoom);
        currentZoom = zoom;
    }

    function setCenter(lat, lng) {
        if (!map) return;
        const currentZoom = map.getZoom();
        map.setView([lat, lng], currentZoom);
    }

    function addSvgMarker(imei, lat, lng, svgFileName, width, height) {
        if (markers[imei]) {
            markers[imei].setLatLng([lat, lng]);
            if (imei == 'myLocation')
                return;

            markerPrevPos[imei] = markers[imei].getLatLng();

            if (markerPrevPos[imei]) {
                var line = L.polyline(
                    [markerPrevPos[imei], [lat, lng]],
                    { color: markerColor[imei], weight: 5, opacity: 1 }
                ).addTo(map);
                trackLines.push(line);
            };
            //return;
        }

        markerColor[imei] = randomColor();

        var currentIcon = L.icon({
                iconUrl: 'file:///android_asset/' + svgFileName,
                iconSize: [width, height],
                iconAnchor: [width/2, height/2],
                popupAnchor: [0, 0]
            });

        if (!customIcons[svgFileName]) {
            customIcons[svgFileName] = L.icon({
                iconUrl: 'file:///android_asset/' + svgFileName,
                iconSize: [width, height],
                iconAnchor: [width/2, height/2],
                popupAnchor: [0, 0]
            });
        }
        if (markers[imei]){
            markers[imei].removeFrom(map)
            };
        markers[imei] = L.marker([lat, lng], {icon: currentIcon})
            .on('click', function(e) {
                AndroidInterface.onMarkerClicked(imei);
            });

        markers[imei].addTo(map)
        markerPrevPos[imei] = [lat, lng];
    }





    function addTrackLine(color, lat1, lng1, lat2, lng2) {
        var line = L.polyline(
            [[lat1, lng1], [lat2, lng2]],
            { color: color, weight: 5, opacity: 1 }
        ).addTo(map);
        trackLines.push(line);
    }

    function undoLastTrackLine() {
        if (trackLines.length === 0) return;

        var lastLine = trackLines.pop();
        map.removeLayer(lastLine);
    }

    function clearAllLayers() {
        removeAllMarkers()

        map.eachLayer(layer => {
            if (layer instanceof L.Polyline || layer instanceof L.Marker) {
                map.removeLayer(layer);
            }
        });

        markerPrevPos = {};
    }

    function removeMarker(imei) {
        if (markers[imei]) {
            map.removeLayer(markers[imei]); // Удалить маркер с карты
            delete markers[imei];           // Удалить запись из объекта markers
        }
    }

    function removeAllMarkers() {
        // Перебираем все маркеры и удаляем их с карты
        Object.values(markers).forEach(marker => {
            map.removeLayer(marker);
        });
        // Очищаем хранилище маркеров
        markers = {};
    }

    function updateMarkerPosition(imei, lat, lng) {
        if (markers[imei]) {
            markers[imei].setLatLng([lat, lng]);
        }
    }

    function zoomIn() {
        map.zoomIn();
        currentZoom++;
    }

    function zoomOut() {
        map.zoomOut();
        currentZoom--;
    }

    function switchTheme(theme) {
        if(currentLayer) map.removeLayer(currentLayer);
        currentLayer = layers[theme];
        currentLayer.addTo(map);
    }

    document.addEventListener('DOMContentLoaded', initMap);
</script>
</body>
</html>